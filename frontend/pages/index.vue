<template>
  <v-container>
    <v-select
      v-model="thisWeekCookingTime"
      item-text="label"
      item-value="value"
      :items="cookingTime"
      label="調理時間"
      return-object
      />
    <v-btn text v-on:click="search">検索する</v-btn>
    <div v-if='serchRecipesByCookingTime'>
      <v-col cols="6" offset="3">
        <v-card>
          <v-card-title>
            <!-- <v-btn text icon @click="deleteRecipe(recipe)">
              <v-icon>clear</v-icon>
            </v-btn> -->
          </v-card-title>
          <v-card-text>{{ serchRecipesByCookingTime.title }}</v-card-text>
          <v-card-text>{{ serchRecipesByCookingTime.description }}</v-card-text>
          <v-card-text>{{ serchRecipesByCookingTime.cookingTime }}</v-card-text>
        </v-card>
      </v-col>
    </div>
    <v-row>
      <v-col cols="6" offset="3">
        <v-card>
          <v-card-title>Register Recipes</v-card-title>
          <v-card-text>
            <v-form>
              <v-container>
                <v-row>
                  <v-col cols="6">
                    <v-text-field v-model="newRecipe.title" label="Title" required />
                  </v-col>
                </v-row>
                <v-row>
                  <v-col cols="12">
                    <v-text-field v-model="newRecipe.description" label="Description" required />
                  </v-col>
                </v-row>
                <v-row>
                  <v-col cols="12">
                    <v-text-field v-model.number="newRecipe.cookingTime" label="cookingTime" required />
                  </v-col>
                </v-row>
                <v-row>
                  <v-col>
                    <v-btn @click="createRecipe(newRecipe)">
                      Register
                    </v-btn>
                  </v-col>
                </v-row>
              </v-container>
            </v-form>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>
    <v-row v-for="recipe in recipes" :key="recipe.id">
      <v-col cols="6" offset="3">
        <v-card>
          <v-card-title>
            <v-btn text icon @click="deleteRecipe(recipe)">
              <v-icon>clear</v-icon>
            </v-btn>
          </v-card-title>
          <v-card-text>{{ recipe.title }}</v-card-text>
          <v-card-text>{{ recipe.description }}</v-card-text>
          <v-card-text>{{ recipe.cookingTime }}</v-card-text>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>

<script>
import recipes from '~/apollo/queries/recipes'
import createRecipe from '~/apollo/mutations/createRecipe'
import deleteRecipe from '~/apollo/mutations/deleteRecipe'
import updateRecipe from '~/apollo/mutations/updateRecipe'
import serchRecipesByCookingTime from '~/apollo/queries/serchRecipesByCookingTime'

export default {
  data() {
    return {
      serchRecipe: null,
      newRecipe: {
        title: '',
        description: '',
        cookingTime: 0,
      },
      thisWeekCookingTime: [""],
      cookingTime: [
        { label: '早い', value: 5},
        { label: '普通', value: 10},
        { label: '遅い', value: 15}
      ]
    }
  },
  mounted: function() {
    console.log(this.serchRecipe)
    console.log(typeof(this.serchRecipe))
  },
  methods: {
    async createRecipe(recipe) {
      try {
        await this.$apollo.mutate({
          mutation: createRecipe,
          variables: {
            id: recipe.id,
            title: recipe.title,
            description: recipe.description,
            cookingTime: recipe.cookingTime,
          },
          refetchQueries: [{
            query: recipes
          }]
        })
        this.newRecipe = { title: '', description: '', cookingTime: '' }
      } catch (e) {
        window.console.log(e)
      }
    },
    async deleteRecipe(recipe) {
      try {
        await this.$apollo.mutate({
          mutation: deleteRecipe,
          variables: {
            id: Number(recipe.id)
          },
          refetchQueries: [{
            query: recipes
          }]
        })
      } catch (e) {
        window.console.log(e)
      }
    },
    async updateRecipe(recipe) {
      try {
        await this.$apollo.mutate({
          mutation: updateRecipe,
          variables: {
            id: recipe.id,
            title: recipe.title,
            description: recipe.description
          },
          refetchQueries: [{
            query: recipes
          }]
        })
      } catch (e) {
        window.console.log(e)
      }
    },
    async search(){
      try{
        await this.$apollo.query({
          query: serchRecipesByCookingTime,
          variables: { cookingTime: 10 }
          }
        )
      } catch (e) {
        console.log(e)
      }
    },
  },
  apollo: {
    recipes: {
      query: recipes
    },
    serchRecipesByCookingTime: {
      query: serchRecipesByCookingTime,
      variables: { cookingTime: 0 }
    }
  }
}
</script>
